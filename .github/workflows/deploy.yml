name: Deploy to Google Play

on:
  push:
    branches:
      - staging
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > "${RUNNER_TEMP}/upload-keystore.jks"

      - name: Configure OAuth credentials
        run: |
          echo "OAUTH_CLIENT_ID=${{ secrets.OAUTH_CLIENT_ID }}" >> local.properties
          echo "OAUTH_CLIENT_SECRET=${{ secrets.OAUTH_CLIENT_SECRET }}" >> local.properties

      - name: Build signed AAB
        env:
          KEYSTORE_FILE: ${{ runner.temp }}/upload-keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          VERSION_CODE=$(( ${{ github.run_number }} + 100 ))
          echo "VERSION_CODE=${VERSION_CODE}" >> "$GITHUB_ENV"
          ./gradlew bundleRelease -PVERSION_CODE=${VERSION_CODE}

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: signed-aab
          path: app/build/outputs/bundle/release/app-release.aab
          retention-days: 7

  deploy-staging:
    needs: build
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: whatsnew

      - name: Download AAB artifact
        uses: actions/download-artifact@v4
        with:
          name: signed-aab

      - name: Upload to Play Store (closed testing track)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ secrets.PLAY_PACKAGE_NAME }}
          releaseFiles: app-release.aab
          track: alpha
          status: draft
          whatsNewDirectory: whatsnew

  deploy-production:
    needs: build
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          sparse-checkout: whatsnew

      - name: Download AAB artifact
        uses: actions/download-artifact@v4
        with:
          name: signed-aab

      - name: Upload to Play Store (production track)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: ${{ secrets.PLAY_PACKAGE_NAME }}
          releaseFiles: app-release.aab
          track: production
          status: draft
          whatsNewDirectory: whatsnew
